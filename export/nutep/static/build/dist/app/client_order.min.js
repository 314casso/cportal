'use strict';

(function () {
    'use strict';

    var utils = {
        reviver: function reviver(key, value) {
            var dateFormat = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}$/;
            if (typeof value === "string" && dateFormat.test(value)) {
                return new Date(value);
            }
            return value;
        },
        checkJob: function checkJob(job, app, jobSuccess) {
            app.loading = true;
            var xhr = new XMLHttpRequest();
            if (!job) {
                app.loading = false;
                return;
            }
            xhr.open('GET', '/api/jobstatus/' + job + '/');
            xhr.onload = function () {
                try {
                    var resp = JSON.parse(xhr.responseText);
                } catch (e) {
                    app.error = "Произошла ошибка обновления данных: " + e;
                }
                if (resp.job == 'started') {
                    setTimeout(utils.checkJob, 1000, job, app, jobSuccess);
                } else {
                    app.loading = false;
                    if (resp.job == 'failed') {
                        app.error = "Произошла ошибка обновления данных";
                    } else {
                        if (jobSuccess) {
                            jobSuccess();
                        } else {
                            app.jobSuccess();
                        }
                    }
                }
            };
            xhr.error = function (e) {
                app.loading = false;
                app.error = "Error " + e.target.status + " occurred while receiving the document.";
            };
            xhr.send();
        },
        pingData: function pingData(url, app, jobSuccess) {
            var xhr = new XMLHttpRequest();
            app.loading = true;
            xhr.open('GET', url);
            xhr.onload = function () {
                var resp = JSON.parse(xhr.responseText);
                utils.checkJob(resp.job, app, jobSuccess);
            };
            xhr.send();
        },

        shortdate: function shortdate(date) {
            if (date) {
                return moment(date).format('DD.MM.YY');
            }
        },
        date: function date(_date) {
            if (_date) {
                return moment(_date).format('DD.MM.YYYY');
            }
        },
        moment: function (_moment) {
            function moment(_x) {
                return _moment.apply(this, arguments);
            }

            moment.toString = function () {
                return _moment.toString();
            };

            return moment;
        }(function (date) {
            if (date) {
                return moment(date).format('DD.MM.YYYY HH:mm');
            }
        }),
        upper: function upper(date) {
            if (date) {
                return date.toUpperCase();
            }
        },
        number: function number(x) {
            if (!x) {
                return null;
            }
            return parseFloat(x).toString().replace(/\B(?=(\d{3})+(?!\d))/g, String.fromCharCode(160));
        },
        sum: function sum(items, prop) {
            return items.reduce(function (a, b) {
                return a + parseFloat(b[prop]);
            }, 0);
        },
        humanFileSize: function humanFileSize(size) {
            var i = size == 0 ? 0 : Math.floor(Math.log(size) / Math.log(1024));
            return (size / Math.pow(1024, i)).toFixed(2) * 1 + ' ' + ['B', 'kB', 'MB', 'GB', 'TB'][i];
        }
    };

    Vue.component('v-select', VueSelect.VueSelect);
    Vue.component('paginate', VuejsPaginate);

    var appTerminalExport = new Vue({
        el: '#app-terminal-export',
        data: {
            items: [],
            orderevents: [],
            loading: false,
            paginate: {
                pageCount: null,
                next: null,
                prev: null,
                page: 1,
                count: 0
            },
            error: '',
            search: '',
            stats: {
                total_rows: 0
            },
            filter: {
                name: '',
                contract: '',
                platform: '',
                perepodacha: '',
                size: [],
                type: [],
                extension: []
            },
            orders: [],
            contract: null,
            selectedOrder: null,
            itemsPerPage: 7
        },
        delimiters: ["<%", "%>"],
        mounted: function mounted() {
            this.fetchOrders();
            this.pingOrders();
        },

        computed: {
            isFiltered: function isFiltered() {
                return this.filter.name || this.filter.contract || this.filter.type.length || this.filter.extension.length || this.filter.platform || this.filter.perepodacha;
            },
            filter_name: function filter_name() {
                return this.filter.name;
            },
            filter_contract: function filter_contract() {
                return this.filter.contract;
            },
            filter_platform: function filter_platform() {
                return this.filter.platform;
            },
            filter_perepodacha: function filter_perepodacha() {
                return this.filter.perepodacha;
            },

            filterOptions: function filterOptions() {}
        },
        watch: {
            filter_name: function filter_name(val) {
                this.paginate.page = 1;
                this.selectedOrder = null;
                this.fetchOrders();
            },
            filter_contract: function filter_contract(val) {
                this.paginate.page = 1;
                this.selectedOrder = null;
                this.fetchOrders();
            },
            filter_platform: function filter_platform(val) {
                this.paginate.page = 1;
                this.selectedOrder = null;
                this.fetchOrders();
            },
            filter_perepodacha: function filter_perepodacha(val) {
                this.paginate.page = 1;
                this.selectedOrder = null;
                this.fetchOrders();
            }
        },
        methods: {
            formatParams: function formatParams(params) {
                return "?" + Object.keys(params).map(function (key) {
                    return key + "=" + encodeURIComponent(params[key]);
                }).join("&");
            },
            selectOrder: function selectOrder(order) {
                this.selectedOrder = order;
            },
            clickCallback: function clickCallback(pageNum) {
                this.paginate.page = pageNum;
                this.fetchOrders();
            },
            customFormatter: function customFormatter(date) {
                return moment(date).format('DD.MM.YYYY');
            },

            checkJob: function checkJob(job) {
                utils.checkJob(job, this);
            },
            jobSuccessOrders: function jobSuccessOrders() {
                this.fetchOrders();
            },
            jobSuccessOrderData: function jobSuccessOrderData() {},
            pingOrders: function pingOrders() {
                this.loading = true;
                utils.pingData('/pingorders/', this, this.jobSuccessOrders);
            },
            pingOrderData: function pingOrderData(order) {
                this.loading = true;
                utils.pingData('/pingorderdata/' + order.id + '/', this, this.jobSuccessOrderData);
            },
            pingContractFiles: function pingContractFiles(contract) {
                this.loading = true;
                utils.pingData('/pingcontractfiles/' + contract.id + '/', this);
            },
            fetchContractFiles: function fetchContractFiles() {
                var _this = this;

                if (!this.contract) {
                    this.items = [];
                    this.stats.total_rows = 0;
                    this.stats.total_unfiltered = 0;
                    return;
                }
                var xhr = new XMLHttpRequest();
                xhr.open('GET', '/api/contractfiles/?contract=' + this.contract.id);
                xhr.onload = function () {
                    try {
                        var data = JSON.parse(xhr.responseText, utils.reviver);
                        _this.items = data;
                    } catch (e) {
                        _this.error = "Произошла ошибка обновления данных: " + e;
                    }
                };
                xhr.send();
            },
            fetchOrders: function fetchOrders() {
                var _this2 = this;

                NProgress.start();
                var xhr = new XMLHttpRequest();
                var params = {
                    page: this.paginate.page
                };
                if (this.isFiltered) {
                    params.name = this.filter.name;
                    params.contract = this.filter.contract;
                    params.platform = this.filter.platform;
                    params.perepodacha = this.filter.perepodacha;
                }

                xhr.open('GET', '/api/clientorders/' + this.formatParams(params));
                xhr.onload = function () {
                    try {
                        var data = JSON.parse(xhr.responseText, utils.reviver);

                        var orderevents = data.results;

                        var pageCount = Math.round(data.count / _this2.itemsPerPage);
                        if (pageCount == 0) {
                            pageCount = 1;
                        }

                        _this2.stats.total_rows = data.count;
                        _this2.paginate.count = data.count;
                        _this2.paginate.pageCount = pageCount;
                        _this2.paginate.next = data.next;
                        _this2.paginate.prev = data.prev;
                        NProgress.done();

                        _this2.orderevents = orderevents;

                        if (data.results && data.results.length) {
                            _this2.items = [data.results[0].event];
                            if (!_this2.selectedOrder) {
                                _this2.selectOrder(data.results[0]);
                            }
                        }
                    } catch (e) {
                        _this2.error = "Произошла ошибка обновления данных: " + e;
                    }
                };
                xhr.send();
            },
            open: function open(file) {
                var wnd = window.open('about:blank', '_blank');
                var xhr = new XMLHttpRequest();
                xhr.open('GET', '/getfileurl/' + file.Guid + '/');
                xhr.onload = function () {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        if (data.url) {
                            wnd.location = data.url;
                        }
                    } catch (e) {
                        this.error = "Произошла ошибка обновления данных: " + e + ": " + xhr.responseText;
                    }
                };
                xhr.send();
            },
            clearSearch: function clearSearch() {
                this.filter.name = "";
            },
            clearContract: function clearContract() {
                this.filter.contract = "";
            },
            clearPlatform: function clearPlatform() {
                this.filter.platform = "";
            },
            clearPerepodacha: function clearPerepodacha() {
                this.filter.perepodacha = "";
            },
            clearDate: function clearDate() {
                this.filter.date = null;
                console.log('OK');
            },
            clearFilter: function clearFilter() {
                this.filter.name = '';
                this.filter.contract = '';
                this.filter.platform = '';
                this.filter.perepodacha = '';
                this.filter.size = [];
                this.filter.type = [];
                this.filter.extention = [];
            },
            setContainer: function setContainer(terminalexport) {
                if (!terminalexport.container) {
                    return false;
                }
                this.container = terminalexport.container;
                return true;
            },
            orderlist: function orderlist(item) {
                var rows = this.orderevents.slice();
                return rows;
            },
            rows: function rows(item) {
                if (item && item.contractevent && item.contractevent.files) {
                    var rows = item.contractevent.files.slice();

                    rows.sort(function (a, b) {
                        if (a.doc_type > b.doc_type) {
                            return 1;
                        }
                        if (a.doc_type < b.doc_type) {
                            return -1;
                        }
                        return 0;
                    });

                    var self = this;
                    var filtered = rows.filter(function (row) {
                        if (!self.isFiltered) {
                            return true;
                        }
                        if (self.filter.name && !(row.title.search(new RegExp(self.filter.name, "i")) != -1)) {
                            return false;
                        }
                        if (self.filter.type.length && !self.filter.type.includes(row.doc_type)) {
                            return false;
                        }
                        if (self.filter.extension.length && !self.filter.extension.includes(row.extension)) {
                            return false;
                        }
                        return true;
                    });
                    self.stats.total_rows = filtered.length;
                    self.stats.total_unfiltered = rows.length;
                    return filtered;
                }
            }
        },
        filters: {
            shortdate: function shortdate(date) {
                return utils.shortdate(date);
            },
            date: function date(_date2) {
                return utils.date(_date2);
            },
            moment: function moment(date) {
                return utils.moment(date);
            },
            upper: function upper(date) {
                return utils.upper(date);
            },
            number: function number(x) {
                return utils.number(x);
            },
            humanFileSize: function humanFileSize(size) {
                return utils.humanFileSize(size);
            }
        }
    });
})();